<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowering and Cultivation Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .department-card {
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .department-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #map-tooltip {
            pointer-events: none;
            z-index: 1000;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-green-800 mb-2">Flowering and Cultivation Simulator</h1>
            <p class="text-xl text-gray-600">Flowering Validation for Coffee and Plantain</p>
            <p class="mt-4 text-sm text-gray-500">
                *Real Data from ML Model. Flowering > 75% = Optimal for Planting/Harvest.
            </p>
        </header>

        <div id="map-tooltip" class="fixed hidden bg-gray-900 text-white p-3 rounded-lg shadow-xl text-sm max-w-xs">
            <h4 id="tooltip-dept-name" class="font-bold mb-1"></h4>
            <div id="tooltip-content"></div>
        </div>

        <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold">Loading data...</p>
            </div>
        </div>

        <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Simulation and Query</h2>
            <div class="flex flex-col gap-4">
                <div class="w-full">
                    <label for="simulation-date" class="block text-sm font-medium text-gray-700 mb-1">Date of simulation:</label>
                    <input type="date" id="simulation-date" onchange="loadDataForDate()"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-gray-700 bg-gray-50">
                    <p id="date-info" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <div class="w-full flex flex-col sm:flex-row gap-3">
                    <select id="department-select"
                        class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-gray-700 bg-gray-50">
                        <option value="" disabled selected>Select a Department</option>
                    </select>
                    <button onclick="displaySelectedDepartment()"
                        class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-md whitespace-nowrap">
                        View Prediction
                    </button>
                </div>
            </div>
            <div id="consultation-result" class="mt-6 p-4 border border-blue-200 bg-blue-50 rounded-lg hidden">
                <p class="font-semibold text-blue-700">Query Result:</p>
                <div id="result-content" class="text-sm mt-2 text-blue-800"></div>
            </div>
        </div>

        <main class="max-w-6xl mx-auto mb-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Interactive Flowering Map</h2>
            <div id="map" class="bg-white p-6 rounded-xl shadow-lg" style="min-height: 500px;"></div>
            <div class="mt-4 flex justify-center space-x-6 text-sm">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-700 mr-2"></span>Optimal Total (>90)</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>Favorable (>75)</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></span>Moderate (60-75)</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-500 mr-2"></span>Low (<60)</div>
            </div>
        </main>

        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Detailed Department Report</h2>
            <div id="department-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <script type="text/javascript">
        let jsonData = {};
        let currentDataStore = [];
        let availableDates = [];
        let simplemapsReady = false;
        const OPTIMAL_THRESHOLD = 75;

        async function loadJSONData() {
            showLoading(true);
            try {
                console.log('üîÑ Attempting to load dataStore.json...');
                const response = await fetch('dataStore.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                console.log('üìÑ File loaded, size:', text.length, 'bytes');
                jsonData = JSON.parse(text);
                availableDates = Object.keys(jsonData).sort();
                if (availableDates.length === 0) {
                    throw new Error('JSON file is empty or has no valid dates');
                }
                console.log(`‚úÖ Successfully loaded data for ${availableDates.length} dates`);
                console.log(`üìÖ Date range: ${availableDates[0]} to ${availableDates[availableDates.length - 1]}`);
                const sampleDate = availableDates[0];
                const sampleDepts = jsonData[sampleDate];
                console.log(`üìä Sample data for ${sampleDate}:`, sampleDepts.length, 'departments');
                if (sampleDepts.length > 0) {
                    console.log('First department example:', sampleDepts[0]);
                }
                return true;
            } catch (error) {
                console.error('‚ùå Error loading JSON file:', error);
                if (window.location.protocol === 'file:') {
                    alert(`‚ö†Ô∏è Cannot load JSON from file:// protocol\n\nYou need to run a local server. Options:\n\n1. Python 3: python -m http.server 8000\n2. Python 2: python -m SimpleHTTPServer 8000\n3. Node.js: npx http-server\n4. VS Code: Install "Live Server" extension\n\nThen open: http://localhost:8000`);
                } else {
                    alert(`Error loading data:\n\n${error.message}\n\nPlease ensure:\n1. dataStore.json exists in the same folder\n2. The file is valid JSON\n3. The file is not empty`);
                }
                useSimulatedData();
                return false;
            } finally {
                showLoading(false);
            }
        }

        function loadJSONFromString() {
            const jsonString = ``;
            if (jsonString.trim() === '') return false;
            try {
                jsonData = JSON.parse(jsonString);
                availableDates = Object.keys(jsonData).sort();
                console.log(`‚úÖ Loaded data from string for ${availableDates.length} dates`);
                return true;
            } catch (error) {
                console.error('‚ùå Error parsing JSON string:', error);
                return false;
            }
        }

        function useSimulatedData() {
            console.error('‚ùå Cannot load JSON file. Please ensure dataStore.json is in the same directory.');
            alert('Error: Cannot load dataStore.json file.\n\nPlease make sure the file is in the same directory as this HTML file.');
        }

        function showLoading(show) {
            const loader = document.getElementById('loading-indicator');
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function loadDataForDate() {
            const dateInput = document.getElementById('simulation-date');
            const selectedDate = dateInput.value;
            const dateInfo = document.getElementById('date-info');
            if (!selectedDate) return;

            console.log('üîç Looking for date:', selectedDate);
            if (jsonData[selectedDate]) {
                currentDataStore = normalizeDataStore(jsonData[selectedDate]);
                dateInfo.textContent = `‚úÖ Data available for ${selectedDate} (${currentDataStore.length} departments)`;
                dateInfo.classList.remove('text-red-500', 'text-amber-600');
                dateInfo.classList.add('text-green-600');
            } else {
                const nearestDate = findNearestDate(selectedDate);
                if (nearestDate) {
                    currentDataStore = normalizeDataStore(jsonData[nearestDate]);
                    dateInfo.textContent = `‚ö†Ô∏è Using nearest available date: ${nearestDate} (${currentDataStore.length} departments)`;
                    dateInfo.classList.remove('text-green-600', 'text-red-500');
                    dateInfo.classList.add('text-amber-600');
                    dateInput.value = nearestDate;
                } else {
                    currentDataStore = [];
                    dateInfo.textContent = `‚ùå No data available`;
                    dateInfo.classList.remove('text-green-600', 'text-amber-600');
                    dateInfo.classList.add('text-red-500');
                }
            }
            updateDepartmentSelector();
            renderAllElements(currentDataStore);
        }

        function normalizeDataStore(dataArray) {
            return dataArray.map(dept => ({
                ...dept,
                coffee_status: Math.round(dept.coffee_status * 100) / 100,
                plantain_status: Math.round(dept.plantain_status * 100) / 100
            }));
        }

        function findNearestDate(targetDate) {
            if (availableDates.length === 0) return null;
            const target = new Date(targetDate + 'T00:00:00');
            let nearest = availableDates[0];
            let minDiff = Math.abs(new Date(availableDates[0] + 'T00:00:00') - target);
            for (const date of availableDates) {
                const diff = Math.abs(new Date(date + 'T00:00:00') - target);
                if (diff < minDiff) {
                    minDiff = diff;
                    nearest = date;
                }
            }
            console.log(`üéØ Nearest date to ${targetDate}: ${nearest}`);
            return nearest;
        }

        function updateDepartmentSelector() {
            const select = document.getElementById('department-select');
            select.innerHTML = '<option value="" disabled selected>Select a Department</option>';
            currentDataStore
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
        }

        function getStatusColor(status) {
            if (status >= 90) return 'bg-green-700';
            if (status >= OPTIMAL_THRESHOLD) return 'bg-green-500';
            if (status >= 60) return 'bg-yellow-500';
            return 'bg-red-500';
        }

        function getMapFillColor(coffeeStatus, plantainStatus) {
            const avg = (coffeeStatus + plantainStatus) / 2;
            if (avg >= 90) return '#065f46';
            if (avg >= OPTIMAL_THRESHOLD) return '#10b981';
            if (avg >= 60) return '#f59e0b';
            return '#ef4444';
        }

        function getSuitabilityMessage(status) {
            if (status >= OPTIMAL_THRESHOLD) {
                return '<span class="text-green-700 font-semibold">Optimal</span> (Ready for Collection/Planting)';
            } else if (status >= 60) {
                return '<span class="text-yellow-700 font-semibold">Moderate</span> (Monitoring Required)';
            } else {
                return '<span class="text-red-700 font-semibold">Low</span> (Unfavorable Conditions)';
            }
        }

        function renderDepartmentCard(department) {
            let highlightClass = '';
            if (department.coffee_status >= 90 || department.plantain_status >= 90) {
                highlightClass = 'border-2 border-green-500 shadow-xl';
            }
            const coffeeColor = getStatusColor(department.coffee_status);
            const coffeeSuitability = getSuitabilityMessage(department.coffee_status);
            const plantainColor = getStatusColor(department.plantain_status);
            const plantainSuitability = getSuitabilityMessage(department.plantain_status);

            return `
            <div class="department-card bg-white p-6 rounded-xl shadow-lg ${highlightClass} flex flex-col justify-between" onclick="showDepartmentDetail('${department.name}')">
                <div>
                    <h3 class="text-2xl font-bold mb-3 text-gray-900">${department.name}</h3>
                    <p class="text-xs text-gray-400 mb-3">Lat: ${department.lat?.toFixed(4) || 'N/A'}, Lon: ${department.lon?.toFixed(4) || 'N/A'}</p>
                </div>
                <div class="mb-4">
                    <p class="text-base font-semibold text-gray-700 flex justify-between items-center mb-1">
                        <span>‚òï Coffee (Flowering)</span>
                        <span class="font-mono text-sm">${department.coffee_status}%</span>
                    </p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${coffeeColor}" style="width: ${department.coffee_status}%"></div>
                    </div>
                    <p class="text-xs mt-1">${coffeeSuitability}</p>
                </div>
                <div>
                    <p class="text-base font-semibold text-gray-700 flex justify-between items-center mb-1">
                        <span>üçå Plantain (Flowering)</span>
                        <span class="font-mono text-sm">${department.plantain_status}%</span>
                    </p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${plantainColor}" style="width: ${department.plantain_status}%"></div>
                    </div>
                    <p class="text-xs mt-1">${plantainSuitability}</p>
                </div>
            </div>
            `;
        }

        // NUEVO: Actualizar mapa usando API de Simplemaps
        function updateMap(currentData) {
            console.log('üó∫Ô∏è Updating Simplemaps with data...');
            
            if (!currentData || currentData.length === 0) {
                console.warn('‚ö†Ô∏è No data to update map');
                return;
            }

            // Verificar que Simplemaps est√© cargado
            if (typeof simplemaps_countrymap === 'undefined') {
                console.error('‚ùå Simplemaps not loaded yet');
                return;
            }

            // Inspeccionar la estructura de Simplemaps
            console.log('Simplemaps object:', simplemaps_countrymap);
            console.log('Available methods:', Object.keys(simplemaps_countrymap));

            try {
                let successCount = 0;
                let failedCount = 0;
                
                // Mapa de conversi√≥n
                const nameToCode = {
                    'AMAZONAS': 'COAMA',
                    'ANTIOQUIA': 'COANT',
                    'ARAUCA': 'COARA',
                    'ATLANTICO': 'COATL',
                    'BOLIVAR': 'COBOL',
                    'BOYACA': 'COBOY',
                    'CALDAS': 'COCAL',
                    'CAQUETA': 'COCAQ',
                    'CASANARE': 'COCAS',
                    'CAUCA': 'COCAU',
                    'CESAR': 'COCES',
                    'CHOCO': 'COCHO',
                    'CORDOBA': 'COCOR',
                    'CUNDINAMARCA': 'COCUN',
                    'GUAINIA': 'COGUA',
                    'GUAVIARE': 'COGUV',
                    'HUILA': 'COHUI',
                    'LA GUAJIRA': 'COLAG',
                    'MAGDALENA': 'COMAG',
                    'META': 'COMET',
                    'NARI√ëO': 'CONAR',
                    'NORTE DE SANTANDER': 'CONSA',
                    'PUTUMAYO': 'COPUT',
                    'QUINDIO': 'COQUI',
                    'RISARALDA': 'CORIS',
                    'SANTANDER': 'COSAN',
                    'SAN ANDRES Y PROVIDENCIA': 'COSAP',
                    'SUCRE': 'COSUC',
                    'TOLIMA': 'COTOL',
                    'VALLE DEL CAUCA': 'COVAC',
                    'VAUPES': 'COVAU',
                    'VICHADA': 'COVID'
                };
                
                // Actualizar cada departamento
                currentData.forEach(dept => {
                    let stateId = dept.id.replace('path-', '').toUpperCase();
                    if (nameToCode[stateId]) {
                        stateId = nameToCode[stateId];
                    }
                    
                    const color = getMapFillColor(dept.coffee_status, dept.plantain_status);
                    const description = `‚òï Caf√©: ${dept.coffee_status}%\n\nüçå Pl√°tano: ${dept.plantain_status}%\n\nClick for details`;
                    
                    // Intentar usar el m√©todo set_state() de Simplemaps
                    if (typeof simplemaps_countrymap.set_state === 'function') {
                        simplemaps_countrymap.set_state(stateId, {
                            color: color,
                            description: description,
                            hover_color: color
                        });
                        successCount++;
                        console.log(`   ‚úÖ ${dept.name} -> ${stateId}`);
                    } else {
                        // Fallback: modificar directamente el mapdata
                        if (simplemaps_countrymap_mapdata && 
                            simplemaps_countrymap_mapdata.state_specific && 
                            simplemaps_countrymap_mapdata.state_specific[stateId]) {
                            
                            simplemaps_countrymap_mapdata.state_specific[stateId].color = color;
                            simplemaps_countrymap_mapdata.state_specific[stateId].description = description;
                            simplemaps_countrymap_mapdata.state_specific[stateId].hover_color = color;
                            successCount++;
                            console.log(`   ‚úÖ ${dept.name} -> ${stateId} (direct)`);
                        } else {
                            failedCount++;
                            console.warn(`   ‚ùå Cannot update: ${stateId} (from ${dept.id})`);
                        }
                    }
                });

                // Refrescar el mapa
                if (typeof simplemaps_countrymap.refresh === 'function') {
                    simplemaps_countrymap.refresh();
                } else if (typeof simplemaps_countrymap.load === 'function') {
                    simplemaps_countrymap.load();
                }
                
                console.log(`‚úÖ Updated ${successCount} departments, ${failedCount} failed`);
            } catch (error) {
                console.error('‚ùå Error updating map:', error);
                console.error('Error details:', error.stack);
            }
        }

        function renderAllElements(currentData) {
            const grid = document.getElementById('department-grid');
            if (!currentData || currentData.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No data available. Please load dataStore.json file.</div>';
            } else {
                console.log('üé® Rendering', currentData.length, 'departments');
                grid.innerHTML = currentData.map(renderDepartmentCard).join('');
                updateMap(currentData);
            }
        }

        function showDepartmentDetail(departmentName) {
            const department = currentDataStore.find(d => d.name === departmentName);
            const resultDiv = document.getElementById('consultation-result');
            const contentDiv = document.getElementById('result-content');

            if (!department) {
                contentDiv.innerHTML = '<span class="text-red-600">Error: Department not found for this date.</span>';
                resultDiv.classList.remove('hidden');
                return;
            }

            const coffeeSuitability = getSuitabilityMessage(department.coffee_status);
            const plantainSuitability = getSuitabilityMessage(department.plantain_status);

            let overallMessage = '';
            if (department.coffee_status >= OPTIMAL_THRESHOLD && department.plantain_status >= OPTIMAL_THRESHOLD) {
                overallMessage = '<p class="text-lg font-bold text-green-700 mt-3">¬°Excellent! Both crops are at optimal flowering stage.</p>';
            } else if (department.coffee_status >= OPTIMAL_THRESHOLD) {
                overallMessage = '<p class="text-lg font-bold text-amber-700 mt-3">Coffee is at its peak! Focus on coffee harvesting.</p>';
            } else if (department.plantain_status >= OPTIMAL_THRESHOLD) {
                overallMessage = '<p class="text-lg font-bold text-sky-700 mt-3">Plantain is at its peak! Focus on plantain harvesting.</p>';
            } else {
                overallMessage = '<p class="text-lg font-bold text-red-700 mt-3">Wait recommended. Neither crop is in optimal condition.</p>';
            }

            contentDiv.innerHTML = `
                <h4 class="text-xl font-bold mb-3">${department.name}</h4>
                <p class="text-xs text-gray-500 mb-3">Coordinates: ${department.lat?.toFixed(4) || 'N/A'}, ${department.lon?.toFixed(4) || 'N/A'}</p>
                <div class="bg-blue-100 p-3 rounded-lg mt-3">
                    <p class="font-semibold text-gray-800 mb-1">Coffee Flowering: ${department.coffee_status}%</p>
                    <p class="text-sm">${coffeeSuitability}</p>
                    <p class="font-semibold text-gray-800 mt-3 mb-1">Plantain Flowering: ${department.plantain_status}%</p>
                    <p class="text-sm">${plantainSuitability}</p>
                </div>
                ${overallMessage}
            `;

            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displaySelectedDepartment() {
            const select = document.getElementById('department-select');
            const selectedName = select.value;
            if (selectedName) {
                showDepartmentDetail(selectedName);
            } else {
                const resultDiv = document.getElementById('consultation-result');
                const contentDiv = document.getElementById('result-content');
                contentDiv.innerHTML = '<span class="text-red-600 font-semibold">Please select a department.</span>';
                resultDiv.classList.remove('hidden');
            }
        }

        async function initializeApp() {
            const dateInput = document.getElementById('simulation-date');
            console.log('üöÄ Initializing app...');
            
            // Cargar datos JSON
            let success = loadJSONFromString();
            if (!success) {
                success = await loadJSONData();
            }

            if (!success || availableDates.length === 0) {
                console.error('‚ùå Failed to initialize: No data available');
                document.getElementById('date-info').textContent = '‚ùå Failed to load data. Check console for details.';
                document.getElementById('date-info').classList.add('text-red-500');
                return;
            }

            // Configurar fecha
            const mostRecentDate = availableDates[availableDates.length - 1];
            dateInput.value = mostRecentDate;
            dateInput.min = availableDates[0];
            dateInput.max = mostRecentDate;
            console.log(`‚úÖ App initialized with date range: ${availableDates[0]} to ${mostRecentDate}`);

            // Esperar a que Simplemaps se cargue
            const checkSimpleMaps = setInterval(() => {
                if (typeof simplemaps_countrymap !== 'undefined') {
                    console.log('‚úÖ Simplemaps loaded successfully');
                    simplemapsReady = true;
                    clearInterval(checkSimpleMaps);
                    loadDataForDate();
                }
            }, 100);

            // Timeout despu√©s de 5 segundos
            setTimeout(() => {
                if (!simplemapsReady) {
                    clearInterval(checkSimpleMaps);
                    console.error('‚ùå Simplemaps failed to load');
                    document.getElementById('map').innerHTML = '<div class="text-center py-12 text-red-600">Map files (mapdata.js, countrymap.js) not found or failed to load.</div>';
                    // A√∫n as√≠ cargar los datos para mostrar las tarjetas
                    loadDataForDate();
                }
            }, 5000);
        }

        window.onload = initializeApp;
    </script>

    <!-- Cargar Simplemaps AL FINAL -->
    <script src="mapdata.js"></script>
    <script src="countrymap.js"></script>
</body>
</html>